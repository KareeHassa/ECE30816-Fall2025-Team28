#!/bin/bash

# ML Model Evaluation System - Run Script
# Usage: ./run [install|test|URL_FILE]

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_success() {
    echo -e "${GREEN}✓ $1${NC}" >&2
}

print_error() {
    echo -e "${RED}✗ Error: $1${NC}" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠ Warning: $1${NC}" >&2
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}" >&2
}

# Function to install dependencies
install_dependencies() {
    print_info "Installing ML Model Evaluation System dependencies..."

    # Check if Python is available
    if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
        print_error "Python is not installed or not in PATH"
        exit 1
    fi

    # Use python3 if available, otherwise python
    PYTHON_CMD="python3"
    if ! command -v python3 &> /dev/null; then
        PYTHON_CMD="python"
    fi

    print_info "Using Python command: $PYTHON_CMD"

    # Check if pip is available
    if ! $PYTHON_CMD -m pip --version &> /dev/null; then
        print_error "pip is not available. Please install pip first."
        exit 1
    fi

    # Install requirements directly (no virtual environment for autograder compatibility)
    if [ -f "requirements.txt" ]; then
        print_info "Installing packages from requirements.txt..."
        $PYTHON_CMD -m pip install -r requirements.txt --user --break-system-packages 2>/dev/null || \
        $PYTHON_CMD -m pip install -r requirements.txt --user 2>/dev/null || \
        $PYTHON_CMD -m pip install -r requirements.txt
        
        if [ $? -eq 0 ]; then
            print_success "All dependencies installed successfully!"
        else
            print_error "Failed to install dependencies"
            exit 1
        fi
    else
        print_error "requirements.txt not found in the current directory"
        exit 1
    fi

    # Check if .env file exists (optional for autograder)
    if [ ! -f ".env" ]; then
        print_warning ".env file not found in  directory"
        print_info "Note: Environment variables may be provided by the autograder"
    else
        print_success "Environment file found at .env"
    fi

    print_success "Installation completed!"
}

# Function to run tests
run_tests() {
    print_info "Running ML Model Evaluation System tests..."
    
    # Check if Python is available
    if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
        print_error "Python is not installed or not in PATH"
        exit 1
    fi
    
    # Use python3 if available, otherwise python
    PYTHON_CMD="python3"
    if ! command -v python3 &> /dev/null; then
        PYTHON_CMD="python"
    fi
    
    # Check if pytest is installed
    if ! $PYTHON_CMD -m pytest --version &> /dev/null; then
        print_error "pytest is not installed. Run './run install' first."
        exit 1
    fi
    
    print_info "Running test suite with pytest..."
    print_info "Test files location: src/Testing/"
    
    # Run actual tests
    $PYTHON_CMD -m pytest src/Testing/ -v --tb=short
    
    if [ $? -eq 0 ]; then
        print_success "All tests passed!"
    else
        print_error "Some tests failed"
        exit 1
    fi
}

# Function to run evaluation on URL file
run_evaluation() {
    local url_file="$1"
    
    print_info "Running ML Model Evaluation on URL file: $url_file"
    
    # Check if file exists
    if [ ! -f "$url_file" ]; then
        print_error "URL file '$url_file' not found"
        exit 1
    fi
    
    # Check if file is readable
    if [ ! -r "$url_file" ]; then
        print_error "URL file '$url_file' is not readable"
        exit 1
    fi
    
    # Check if file is not empty
    if [ ! -s "$url_file" ]; then
        print_warning "URL file '$url_file' is empty"
    fi
    
    # Validate file format (basic check for URLs)
    local line_count=$(wc -l < "$url_file")
    local url_count=$(grep -c "^https\?://" "$url_file" || true)
    
    print_info "File validation:"
    print_info "  - Total lines: $line_count"
    print_info "  - URLs detected: $url_count"
    
    if [ $url_count -eq 0 ]; then
        print_warning "No valid URLs (http/https) detected in the file"
    fi
    
    # Check if Python is available
    if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
        print_error "Python is not installed or not in PATH"
        exit 1
    fi
    
    # Use python3 if available, otherwise python
    PYTHON_CMD="python3"
    if ! command -v python3 &> /dev/null; then
        PYTHON_CMD="python"
    fi
    
    print_success "URL file validation passed!"
    
    # Run evaluation
    print_info "Running evaluation on URLs from $url_file..."
    
    # Pass the URL file to the main evaluation script
    $PYTHON_CMD src/main.py "$url_file"
    
    if [ $? -eq 0 ]; then
        print_success "Evaluation completed successfully!"
    else
        print_error "Evaluation failed"
        exit 1
    fi
}

# Function to show usage
show_usage() {
    echo "ML Model Evaluation System"
    echo ""
    echo "Usage: ./run [COMMAND|URL_FILE]"
    echo ""
    echo "Commands:"
    echo "  install     Install all required dependencies"
    echo "  test        Run the test suite"
    echo "  URL_FILE    Run evaluation on URLs in the specified file"
    echo ""
    echo "Examples:"
    echo "  ./run install"
    echo "  ./run test"
    echo "  ./run sample_urls.txt"
    echo ""
}

# Main script logic
main() {
    # Check if no arguments provided
    if [ $# -eq 0 ]; then
        print_error "No command or URL file specified"
        show_usage
        exit 1
    fi
    
    local command="$1"
    
    case "$command" in
        "install")
            install_dependencies
            ;;
        "test")
            run_tests
            ;;
        "-h"|"--help"|"help")
            show_usage
            ;;
        *)
            # Assume it's a URL file
            run_evaluation "$command"
            ;;
    esac
}

# Run main function with all arguments
main "$@"